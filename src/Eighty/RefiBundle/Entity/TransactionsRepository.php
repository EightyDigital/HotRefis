<?php

namespace Eighty\RefiBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * TransactionsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TransactionsRepository extends EntityRepository
{
	public function filterSectors()
	{
		return $this->getEntityManager()
			->createQuery(
				'SELECT 
					  t.urakey,
					  COUNT(t.id) as num_prospects,
					  t.longitude,
					  t.latitude,
					  t.sector,
					  pr.longitude AS pr_long,
					  pr.latitude AS pr_lat,
					  pr.name AS sector_name,
					  AVG(t.price) AS average_price,
					  AVG(t.newprice) AS average_newprice,
					  AVG(p.age) AS average_prospect_age,
					  AVG(p.derivedIncome) AS average_income,
					  AVG(pl.loanAmount) AS average_loan,
					  AVG(pl.ltv) AS average_ltv,
					  AVG(
						timestampdiff(YEAR, pl.loanDate, CURRENT_DATE())
					  ) AS average_loan_age
					FROM RefiBundle:Prospectloan pl
					JOIN RefiBundle:Transactions t
						WITH t.id = pl.transactionId
					JOIN RefiBundle:Postalregion pr
						WITH t.sector = pr.regionCode
					JOIN RefiBundle:Prospect p
						WITH p.id = pl.prospectId
					GROUP BY t.urakey
					ORDER BY t.sector ASC
				'
			)
			->getArrayResult();
	}
	
	public function fetchProspectByTransactionsId($id)
	{
		return $this->getEntityManager()
			->createQuery(
				'SELECT p.id,
						p.age,
						p.derivedIncome
					FROM RefiBundle:Prospect p
					LEFT JOIN RefiBundle:Prospectproperty pp
					WITH p.id = pp.prospectId  
					WHERE pp.salesId = :ppSalesId
				'
			)
			->setParameter('ppSalesId', $id)
			->getArrayResult();
	}
	
	public function fetchLoanByTransactionsAndProspectId($tid, $pid)
	{
		return $this->getEntityManager()
			->createQuery(
				'SELECT pl.loanAmount,
						pl.ltv,
						pl.loanDate
					FROM RefiBundle:Prospectloan pl
					WHERE pl.transactionId = :tId
					AND pl.prospectId = :pId
				'
			)
			->setParameter('tId', $tid)
			->setParameter('pId', $pid)
			->getArrayResult();
	}
	
	public function fetchAssetsByProspectId($pid)
	{
		return $this->getEntityManager()
			->createQuery(
				'SELECT 
					  COUNT(pl.transactionId) as count_tid,
					  SUM(t.newprice) as sum_nprice
					FROM
					  RefiBundle:Prospectloan pl 
					JOIN RefiBundle:Transactions t 
					WITH pl.transactionId = t.id
					WHERE pl.prospectId = :pId
				'
			)
			->setParameter('pId', $pid)
			->getArrayResult();
	}
}